<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>üç∫ AlcoTracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,sans-serif;background:#0f0f1a;color:#fff}
.app{height:100%;display:flex;flex-direction:column}
.top{background:#0f0f1a;padding:10px 16px;border-bottom:1px solid #222;flex-shrink:0}
.top h1{font-size:16px;display:flex;align-items:center;justify-content:space-between}
.top .user{color:#888;font-size:13px}
.stats{display:flex;gap:8px;padding:10px 12px;flex-shrink:0}
.stat{flex:1;background:#ffffff0a;border-radius:12px;padding:12px;text-align:center}
.stat .num{font-size:28px;font-weight:800}
.stat .lbl{font-size:10px;color:#666;margin-top:2px}
.bac-ok{color:#2ecc71}
.bac-warn{color:#f1c40f}
.bac-danger{color:#e74c3c}
.drive{padding:8px 12px;flex-shrink:0}
.drive-box{padding:10px;border-radius:10px;text-align:center;font-size:13px;font-weight:600}
.drive-ok{background:#2ecc7122;color:#2ecc71}
.drive-wait{background:#e74c3c22;color:#e74c3c}
.tabs{display:flex;padding:0 12px;gap:4px;flex-shrink:0}
.tab{flex:1;padding:10px;border:none;border-radius:10px 10px 0 0;font-size:13px;font-weight:600;cursor:pointer}
.tab.active{background:#1a1a2e;color:#fff}
.tab:not(.active){background:#0a0a12;color:#666}
.panels{flex:1;overflow:hidden;background:#1a1a2e}
.panel{height:100%;overflow-y:auto;padding:12px;display:none}
.panel.active{display:block}
.food-row{display:flex;gap:6px;margin-bottom:10px}
.food-btn{flex:1;padding:10px;border-radius:8px;border:2px solid #333;background:transparent;color:#fff;font-size:12px;cursor:pointer}
.food-btn.active{border-color:#2ecc71;background:#2ecc7122}
.drinks{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.drink{padding:10px 6px;border-radius:10px;background:#ffffff0a;border:none;color:#fff;text-align:center;cursor:pointer}
.drink:active{background:#ffffff15}
.drink .em{font-size:24px}
.drink .nm{font-size:10px;margin-top:2px;line-height:1.1}
.hist-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#ffffff08;border-radius:8px;margin-bottom:6px;font-size:13px}
.hist-item .del{background:#e74c3c;border:none;color:#fff;width:26px;height:26px;border-radius:6px;cursor:pointer;font-size:12px}
.leader{margin-bottom:8px;padding:12px;background:#ffffff08;border-radius:10px;display:flex;align-items:center;gap:12px}
.leader .pos{font-size:24px;width:36px;text-align:center}
.leader .info{flex:1}
.leader .name{font-weight:700;font-size:15px}
.leader .detail{color:#888;font-size:11px}
.leader .ml{font-size:18px;font-weight:800;color:#e94560}
.chart-box{background:#ffffff08;border-radius:10px;padding:10px;margin-bottom:12px}
.empty{text-align:center;color:#666;padding:30px}
.reset{width:100%;padding:12px;border-radius:10px;border:1px solid #e94560;background:transparent;color:#e94560;font-size:14px;cursor:pointer;margin-top:10px}

/* MODAL BICCHIERE */
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:#000c;display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
.modal.show{display:flex}
.modal-box{background:#1a1a2e;border-radius:20px;padding:20px;width:100%;max-width:300px;text-align:center}
.modal-title{font-size:18px;margin-bottom:4px}
.modal-sub{color:#888;font-size:13px;margin-bottom:16px}
.glass-wrap{position:relative;width:120px;height:200px;margin:0 auto 16px;cursor:pointer}
.glass{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:80px;height:180px;border:4px solid #fff;border-top:none;border-radius:0 0 20px 20px;background:#ffffff11;overflow:hidden}
.glass-fill{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,#e94560,#ff6b6b);transition:height .15s}
.glass-marks{position:absolute;right:-30px;top:0;bottom:0;display:flex;flex-direction:column;justify-content:space-between;font-size:10px;color:#666;padding:10px 0}
.glass-ml{font-size:32px;font-weight:800;color:#e94560;margin:8px 0}
.modal-btns{display:flex;gap:8px;margin-top:12px}
.modal-btn{flex:1;padding:14px;border-radius:10px;border:none;font-size:15px;font-weight:600;cursor:pointer}
.modal-btn.cancel{background:#333;color:#fff}
.modal-btn.confirm{background:#e94560;color:#fff}
.quick-btns{display:flex;gap:6px;justify-content:center;margin-bottom:12px}
.quick-btn{padding:8px 12px;border-radius:8px;background:#ffffff11;border:none;color:#fff;font-size:12px;cursor:pointer}
.quick-btn:active{background:#ffffff22}
</style>
</head>
<body>

<div class="app">
  <div class="top">
    <h1>üç∫ AlcoTracker <span class="user" id="userName"></span></h1>
  </div>
  
  <div class="stats">
    <div class="stat">
      <div class="num bac-ok" id="bac">0.00</div>
      <div class="lbl">g/L SANGUE</div>
    </div>
    <div class="stat">
      <div class="num" id="totalMl" style="color:#3498db">0</div>
      <div class="lbl">ML BEVUTI</div>
    </div>
    <div class="stat">
      <div class="num" id="totalDrinks" style="color:#9b59b6">0</div>
      <div class="lbl">BEVANDE</div>
    </div>
  </div>
  
  <div class="drive">
    <div class="drive-box drive-ok" id="drive">üöó Puoi guidare!</div>
  </div>
  
  <div class="tabs">
    <button class="tab active" onclick="showTab(0)">‚ûï Bevi</button>
    <button class="tab" onclick="showTab(1)">üìä Grafico</button>
    <button class="tab" onclick="showTab(2)">üèÜ Classifica</button>
  </div>
  
  <div class="panels">
    <div class="panel active" id="p0">
      <div class="food-row">
        <button class="food-btn" data-f="vuoto" onclick="setFood('vuoto')">üò∂ Digiuno</button>
        <button class="food-btn active" data-f="medio" onclick="setFood('medio')">üçï Medio</button>
        <button class="food-btn" data-f="pieno" onclick="setFood('pieno')">üçù Sazio</button>
      </div>
      <div class="drinks" id="drinks"></div>
      <button class="reset" onclick="reset()">üîÑ Nuova Sessione</button>
    </div>
    
    <div class="panel" id="p1">
      <div class="chart-box">
        <canvas id="chart" height="200"></canvas>
      </div>
      <h4 style="margin:12px 0 8px;font-size:14px">üìú Cronologia</h4>
      <div id="hist"><div class="empty">Nessuna bevanda</div></div>
    </div>
    
    <div class="panel" id="p2">
      <h4 style="margin-bottom:12px;font-size:14px">üèÜ Chi ha bevuto di pi√π?</h4>
      <div id="leaderboard"><div class="empty">Nessun partecipante</div></div>
    </div>
  </div>
</div>

<!-- MODAL BICCHIERE -->
<div class="modal" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <div class="modal-title" id="modalTitle">üç∫ Birra</div>
    <div class="modal-sub">Tocca il bicchiere per indicare il livello</div>
    
    <div class="quick-btns">
      <button class="quick-btn" onclick="setLevel(25)">¬º</button>
      <button class="quick-btn" onclick="setLevel(50)">¬Ω</button>
      <button class="quick-btn" onclick="setLevel(75)">¬æ</button>
      <button class="quick-btn" onclick="setLevel(100)">Pieno</button>
    </div>
    
    <div class="glass-wrap" id="glassWrap">
      <div class="glass">
        <div class="glass-fill" id="glassFill" style="height:100%"></div>
      </div>
      <div class="glass-marks">
        <span>100%</span>
        <span>75%</span>
        <span>50%</span>
        <span>25%</span>
        <span>0%</span>
      </div>
    </div>
    
    <div class="glass-ml"><span id="mlValue">330</span> ml</div>
    
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal()">Annulla</button>
      <button class="modal-btn confirm" onclick="confirmDrink()">‚úì Aggiungi</button>
    </div>
  </div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import{getDatabase,ref,set,onValue,remove}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const db=getDatabase(initializeApp({
  apiKey:"AIzaSyBxYLAaFJqFxHkZ2CVU3sFwUCEp60gis2U",
  databaseURL:"https://copilota-6d94a-default-rtdb.firebaseio.com",
  projectId:"copilota-6d94a"
}));

const DRINKS=[
  {n:"Birra 33cl",e:"üç∫",ml:330,a:5},
  {n:"Birra 50cl",e:"üç∫",ml:500,a:5},
  {n:"Birra DM",e:"üç∫",ml:400,a:8},
  {n:"Vino",e:"üç∑",ml:150,a:13},
  {n:"Prosecco",e:"ü•Ç",ml:150,a:11},
  {n:"Spritz",e:"üß°",ml:200,a:8},
  {n:"Negroni",e:"üç∏",ml:90,a:25},
  {n:"Gin Tonic",e:"üç∏",ml:200,a:12},
  {n:"Mojito",e:"üçπ",ml:250,a:10},
  {n:"Cuba Libre",e:"ü•É",ml:250,a:10},
  {n:"Whisky",e:"ü•É",ml:40,a:40},
  {n:"Vodka",e:"üç∏",ml:40,a:40},
  {n:"Vodka RB",e:"‚ö°",ml:250,a:8},
  {n:"Tequila",e:"üåµ",ml:40,a:40},
  {n:"Shot",e:"üî•",ml:40,a:35},
  {n:"Amaro",e:"üçÇ",ml:50,a:30},
  {n:"Jager",e:"ü¶å",ml:40,a:35},
  {n:"Long Island",e:"üçπ",ml:300,a:22}
];

let uid=localStorage.getItem('alcoId');
let uname=localStorage.getItem('alcoName');
if(!uid){location.href='index.html';}
document.getElementById('userName').textContent=uname;

let chart;
let selectedDrink=null;
let selectedLevel=100;

// Render drinks
document.getElementById('drinks').innerHTML=DRINKS.map((d,i)=>`
  <button class="drink" onclick="openModal(${i})">
    <span class="em">${d.e}</span>
    <div class="nm">${d.n}</div>
  </button>`).join('');

// Modal functions
window.openModal=(i)=>{
  selectedDrink=DRINKS[i];
  selectedLevel=100;
  document.getElementById('modalTitle').textContent=`${selectedDrink.e} ${selectedDrink.n}`;
  updateGlass();
  document.getElementById('modal').classList.add('show');
};

window.closeModal=()=>{
  document.getElementById('modal').classList.remove('show');
};

window.setLevel=(pct)=>{
  selectedLevel=pct;
  updateGlass();
};

function updateGlass(){
  document.getElementById('glassFill').style.height=selectedLevel+'%';
  const ml=Math.round(selectedDrink.ml*(selectedLevel/100));
  document.getElementById('mlValue').textContent=ml;
}

// Touch/click on glass
document.getElementById('glassWrap').addEventListener('click',(e)=>{
  const rect=e.currentTarget.getBoundingClientRect();
  const y=e.clientY-rect.top;
  const pct=Math.round(Math.max(0,Math.min(100,(1-y/rect.height)*100)));
  selectedLevel=pct;
  updateGlass();
});

window.confirmDrink=async()=>{
  const ml=Math.round(selectedDrink.ml*(selectedLevel/100));
  const g=ml*(selectedDrink.a/100)*0.789;
  await set(ref(db,`alco/${uid}/drinks/d${Date.now()}`),{
    n:selectedDrink.n,e:selectedDrink.e,ml,g,t:Date.now()
  });
  closeModal();
};

window.showTab=(i)=>{
  document.querySelectorAll('.tab').forEach((t,j)=>t.classList.toggle('active',i===j));
  document.querySelectorAll('.panel').forEach((p,j)=>p.classList.toggle('active',i===j));
};

window.setFood=async(f)=>{
  document.querySelectorAll('.food-btn').forEach(b=>b.classList.toggle('active',b.dataset.f===f));
  await set(ref(db,`alco/${uid}/food`),f);
};

window.del=async(id)=>{await remove(ref(db,`alco/${uid}/drinks/${id}`));};

window.reset=()=>{
  if(confirm('Nuova sessione?')){
    localStorage.clear();
    location.href='index.html';
  }
};

function calcBAC(data){
  if(!data?.drinks)return{now:0,pts:[]};
  const drinks=Object.values(data.drinks).sort((a,b)=>a.t-b.t);
  if(!drinks.length)return{now:0,pts:[]};
  
  const W=data.peso||70,r=data.sesso==='M'?0.68:0.55,beta=0.15;
  const absTime={vuoto:30,medio:60,pieno:90}[data.food||'medio'];
  const now=Date.now(),start=drinks[0].t,end=now+6*3600000;
  const pts=[];
  
  for(let t=start;t<=end;t+=300000){
    let bac=0;
    for(const d of drinks){
      if(d.t>t)continue;
      const mins=(t-d.t)/60000;
      const peak=d.g/(W*r);
      const abs=mins<absTime?Math.sin((mins/absTime)*(Math.PI/2)):1;
      const elim=beta*Math.max(0,(mins-absTime)/60);
      bac+=Math.max(0,peak*abs-elim);
    }
    pts.push({t,bac:Math.round(bac*100)/100});
  }
  return{now:pts.find(p=>p.t>=now)?.bac||0,pts};
}

function update(data){
  const{now,pts}=calcBAC(data);
  const drinks=data?.drinks?Object.entries(data.drinks).map(([id,d])=>({id,...d})):[];
  
  const bacEl=document.getElementById('bac');
  bacEl.textContent=now.toFixed(2);
  bacEl.className='num '+(now<0.3?'bac-ok':now<0.5?'bac-warn':now<0.8?'bac-danger':'bac-extreme');
  
  const totalMl=drinks.reduce((s,d)=>s+(d.ml||0),0);
  document.getElementById('totalMl').textContent=totalMl;
  document.getElementById('totalDrinks').textContent=drinks.length;
  
  const drv=document.getElementById('drive');
  if(now<0.5){
    drv.className='drive-box drive-ok';
    drv.innerHTML='üöó Puoi guidare!';
  }else{
    const safe=pts.find(p=>p.t>Date.now()&&p.bac<0.5);
    if(safe){
      const m=Math.ceil((safe.t-Date.now())/60000);
      drv.className='drive-box drive-wait';
      drv.innerHTML=`‚õî Aspetta ${Math.floor(m/60)}h ${m%60}m`;
    }else{
      drv.className='drive-box drive-wait';
      drv.innerHTML='‚õî NON guidare!';
    }
  }
  
  if(pts.length){
    const labels=pts.filter((_,i)=>i%4===0).map(p=>new Date(p.t).toLocaleTimeString('it',{hour:'2-digit',minute:'2-digit'}));
    const values=pts.filter((_,i)=>i%4===0).map(p=>p.bac);
    const ctx=document.getElementById('chart');
    if(chart){
      chart.data.labels=labels;
      chart.data.datasets[0].data=values;
      chart.update();
    }else{
      chart=new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            {data:values,borderColor:'#e94560',backgroundColor:'#e9456033',fill:true,tension:.4,pointRadius:0},
            {data:Array(labels.length).fill(0.5),borderColor:'#e74c3c55',borderDash:[5,5],pointRadius:0}
          ]
        },
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:1.2,grid:{color:'#ffffff11'}},x:{grid:{display:false},ticks:{maxTicksLimit:5}}}}
      });
    }
  }
  
  document.getElementById('hist').innerHTML=drinks.length?drinks.sort((a,b)=>b.t-a.t).map(d=>`
    <div class="hist-item">
      <span>${d.e} ${d.n} <span style="color:#666">${d.ml}ml</span></span>
      <button class="del" onclick="del('${d.id}')">‚úï</button>
    </div>`).join(''):'<div class="empty">Nessuna bevanda</div>';
  
  document.querySelectorAll('.food-btn').forEach(b=>b.classList.toggle('active',b.dataset.f===(data?.food||'medio')));
}

onValue(ref(db,'alco'),snap=>{
  const all=snap.val()||{};
  const users=Object.entries(all).map(([id,u])=>{
    const drinks=u.drinks?Object.values(u.drinks):[];
    const ml=drinks.reduce((s,d)=>s+(d.ml||0),0);
    return{id,name:u.nome||'???',ml,count:drinks.length};
  }).filter(u=>u.ml>0).sort((a,b)=>b.ml-a.ml);
  
  const medals=['ü•á','ü•à','ü•â'];
  document.getElementById('leaderboard').innerHTML=users.length?users.map((u,i)=>`
    <div class="leader">
      <div class="pos">${medals[i]||i+1}</div>
      <div class="info">
        <div class="name">${u.name}</div>
        <div class="detail">${u.count} bevande</div>
      </div>
      <div class="ml">${u.ml}ml</div>
    </div>`).join(''):'<div class="empty">Nessun partecipante</div>';
});

let lastData=null;
onValue(ref(db,`alco/${uid}`),snap=>{
  if(snap.exists()){
    lastData=snap.val();
    update(lastData);
  }
});

// Auto-refresh ogni 30 secondi per ricalcolare il BAC (che cambia nel tempo)
setInterval(()=>{
  if(lastData)update(lastData);
},30000);
</script>
</body>
</html>
