<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>üç∫ AlcoTracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#0f0f1a;color:#fff;min-height:100vh;overflow-x:hidden}
.top{background:linear-gradient(135deg,#1a1a2e,#0f0f1a);padding:12px 16px;position:sticky;top:0;z-index:100;border-bottom:1px solid #333}
.top h1{font-size:18px;display:flex;align-items:center;gap:8px}
.top h1 span{font-size:12px;color:#888;font-weight:400}
.bac-card{background:linear-gradient(135deg,#16213e,#1a1a2e);margin:12px;border-radius:16px;padding:20px;text-align:center}
.bac-num{font-size:72px;font-weight:800;line-height:1}
.bac-ok{color:#2ecc71}
.bac-warn{color:#f1c40f}
.bac-danger{color:#e74c3c}
.bac-extreme{color:#9b59b6;animation:pulse .8s infinite}
@keyframes pulse{50%{opacity:.5}}
.bac-label{color:#666;font-size:13px;margin-top:4px}
.drive-box{margin-top:12px;padding:12px;border-radius:10px;font-size:14px;font-weight:600}
.drive-ok{background:#2ecc7122;color:#2ecc71;border:1px solid #2ecc71}
.drive-wait{background:#e74c3c22;color:#e74c3c;border:1px solid #e74c3c}
.chart-wrap{margin:0 12px;background:#ffffff08;border-radius:12px;padding:12px}
.tabs{display:flex;margin:12px;gap:6px}
.tab{flex:1;padding:12px;border-radius:10px;border:none;font-size:14px;font-weight:600;cursor:pointer;transition:.2s}
.tab.active{background:#e94560;color:#fff}
.tab:not(.active){background:#ffffff11;color:#888}
.panel{display:none;margin:0 12px 80px}
.panel.active{display:block}
.food-row{display:flex;gap:8px;margin-bottom:12px}
.food-btn{flex:1;padding:14px 8px;border-radius:10px;border:2px solid #333;background:transparent;color:#fff;font-size:13px;cursor:pointer}
.food-btn.active{border-color:#2ecc71;background:#2ecc7122}
.search{width:100%;padding:12px;border-radius:10px;border:1px solid #333;background:#ffffff11;color:#fff;font-size:15px;margin-bottom:10px}
.drinks{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;max-height:50vh;overflow-y:auto;padding-bottom:20px}
.drink{padding:14px 10px;border-radius:12px;background:#ffffff11;border:none;color:#fff;text-align:center;cursor:pointer;transition:.15s}
.drink:active{transform:scale(.95);background:#ffffff22}
.drink .em{font-size:28px;display:block;margin-bottom:4px}
.drink .nm{font-size:12px;line-height:1.2}
.drink .al{color:#e94560;font-size:11px;margin-top:2px}
.hist-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#ffffff08;border-radius:10px;margin-bottom:6px}
.hist-item .info{font-size:14px}
.hist-item .time{color:#666;font-size:12px}
.hist-item .del{background:#e74c3c;border:none;color:#fff;width:28px;height:28px;border-radius:8px;cursor:pointer}
.bottom{position:fixed;bottom:0;left:0;right:0;padding:12px;background:linear-gradient(to top,#0f0f1a 60%,transparent)}
.reset{width:100%;padding:14px;border-radius:12px;border:1px solid #e94560;background:transparent;color:#e94560;font-size:15px;font-weight:600;cursor:pointer}
.empty{text-align:center;color:#666;padding:40px}
</style>
</head>
<body>

<div class="top">
  <h1>üç∫ AlcoTracker <span id="userName"></span></h1>
</div>

<div class="bac-card">
  <div class="bac-num bac-ok" id="bac">0.00</div>
  <div class="bac-label">g/L nel sangue</div>
  <div class="drive-box drive-ok" id="drive">üöó Puoi guidare!</div>
</div>

<div class="chart-wrap">
  <canvas id="chart" height="120"></canvas>
</div>

<div class="tabs">
  <button class="tab active" onclick="showTab('add')">‚ûï Aggiungi</button>
  <button class="tab" onclick="showTab('hist')">üìú Cronologia</button>
</div>

<div class="panel active" id="panel-add">
  <div class="food-row">
    <button class="food-btn" data-f="vuoto" onclick="setFood('vuoto')">üò∂<br>Digiuno</button>
    <button class="food-btn active" data-f="medio" onclick="setFood('medio')">üçï<br>Medio</button>
    <button class="food-btn" data-f="pieno" onclick="setFood('pieno')">üçù<br>Sazio</button>
  </div>
  <input type="text" class="search" id="search" placeholder="üîç Cerca bevanda..." oninput="filter()">
  <div class="drinks" id="drinks"></div>
</div>

<div class="panel" id="panel-hist">
  <div id="hist"><div class="empty">Nessuna bevanda</div></div>
</div>

<div class="bottom">
  <button class="reset" onclick="reset()">üîÑ Nuova Sessione</button>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import{getDatabase,ref,set,onValue,remove}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const db=getDatabase(initializeApp({
  apiKey:"AIzaSyBxYLAaFJqFxHkZ2CVU3sFwUCEp60gis2U",
  databaseURL:"https://copilota-6d94a-default-rtdb.firebaseio.com",
  projectId:"copilota-6d94a"
}));

const DRINKS=[
  {n:"Birra 33cl",e:"üç∫",ml:330,a:5},
  {n:"Birra 50cl",e:"üç∫",ml:500,a:5},
  {n:"Birra doppio malto",e:"üç∫",ml:400,a:8},
  {n:"Vino rosso",e:"üç∑",ml:150,a:13.5},
  {n:"Vino bianco",e:"ü•Ç",ml:150,a:12},
  {n:"Prosecco",e:"ü•Ç",ml:150,a:11},
  {n:"Spritz Aperol",e:"üß°",ml:200,a:8},
  {n:"Spritz Campari",e:"‚ù§Ô∏è",ml:200,a:11},
  {n:"Negroni",e:"üç∏",ml:90,a:25},
  {n:"Gin Tonic",e:"üç∏",ml:200,a:12},
  {n:"Mojito",e:"üçπ",ml:250,a:10},
  {n:"Cuba Libre",e:"ü•É",ml:250,a:10},
  {n:"Moscow Mule",e:"üçπ",ml:200,a:10},
  {n:"Whisky liscio",e:"ü•É",ml:40,a:40},
  {n:"Rum liscio",e:"ü•É",ml:40,a:40},
  {n:"Vodka liscia",e:"üç∏",ml:40,a:40},
  {n:"Vodka RedBull",e:"‚ö°",ml:250,a:8},
  {n:"Tequila shot",e:"üåµ",ml:40,a:40},
  {n:"Limoncello",e:"üçã",ml:40,a:30},
  {n:"Grappa",e:"üçá",ml:40,a:42},
  {n:"Amaro",e:"üçÇ",ml:50,a:30},
  {n:"Jagermeister",e:"ü¶å",ml:40,a:35},
  {n:"Sambuca",e:"‚≠ê",ml:40,a:38},
  {n:"Long Island",e:"üçπ",ml:300,a:22},
  {n:"Champagne",e:"üçæ",ml:150,a:12},
  {n:"Sangria",e:"üç∑",ml:200,a:8},
  {n:"Caipirinha",e:"üçπ",ml:200,a:15},
  {n:"Sex on Beach",e:"üèñÔ∏è",ml:250,a:10},
  {n:"Margarita",e:"üç∏",ml:150,a:13},
  {n:"Aperol Soda",e:"üß°",ml:150,a:8}
];

let uid=localStorage.getItem('alcoId');
let uname=localStorage.getItem('alcoName');
if(!uid){location.href='index.html';}
document.getElementById('userName').textContent=uname;

let chart;
const ctx=document.getElementById('chart').getContext('2d');

function render(list){
  document.getElementById('drinks').innerHTML=list.map((d,i)=>`
    <button class="drink" onclick="add(${DRINKS.indexOf(d)})">
      <span class="em">${d.e}</span>
      <span class="nm">${d.n}</span>
      <span class="al">${d.a}% ¬∑ ${d.ml}ml</span>
    </button>`).join('');
}
render(DRINKS);

window.filter=()=>{
  const q=document.getElementById('search').value.toLowerCase();
  render(DRINKS.filter(d=>d.n.toLowerCase().includes(q)));
};

window.showTab=(t)=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  document.querySelector(`.tab:nth-child(${t==='add'?1:2})`).classList.add('active');
  document.getElementById('panel-'+t).classList.add('active');
};

window.setFood=async(f)=>{
  document.querySelectorAll('.food-btn').forEach(b=>b.classList.toggle('active',b.dataset.f===f));
  await set(ref(db,`alco/${uid}/food`),f);
};

window.add=async(i)=>{
  const d=DRINKS[i];
  const grams=d.ml*(d.a/100)*0.789;
  await set(ref(db,`alco/${uid}/drinks/d${Date.now()}`),{
    n:d.n,e:d.e,g:grams,t:Date.now()
  });
};

window.del=async(id)=>{await remove(ref(db,`alco/${uid}/drinks/${id}`));};

window.reset=()=>{
  if(confirm('Nuova sessione?')){
    localStorage.clear();
    location.href='index.html';
  }
};

// FORMULA WIDMARK MIGLIORATA con curva di assorbimento
function calcBAC(data){
  if(!data||!data.drinks)return{now:0,pts:[]};
  
  const drinks=Object.entries(data.drinks).map(([id,d])=>({id,...d})).sort((a,b)=>a.t-b.t);
  if(!drinks.length)return{now:0,pts:[]};
  
  const W=data.peso||70;
  const r=data.sesso==='M'?0.68:0.55;
  const beta=0.15; // g/L/ora eliminazione
  
  // Tempo di assorbimento in base al cibo
  const absTime={vuoto:30,medio:60,pieno:90}[data.food||'medio']; // minuti al picco
  
  const now=Date.now();
  const start=drinks[0].t;
  const end=now+8*3600000; // +8 ore
  const pts=[];
  
  for(let t=start;t<=end;t+=300000){ // ogni 5 min
    let bac=0;
    
    for(const drink of drinks){
      if(drink.t>t)continue;
      
      const minsSinceDrink=(t-drink.t)/60000;
      const peakBAC=drink.g/(W*r*10); // BAC massimo teorico
      
      // Fase di ASSORBIMENTO (curva sinusoidale fino al picco)
      let absorption=1;
      if(minsSinceDrink<absTime){
        absorption=Math.sin((minsSinceDrink/absTime)*(Math.PI/2)); // 0‚Üí1 graduale
      }
      
      // Fase di ELIMINAZIONE (dopo il picco)
      const hoursAfterPeak=Math.max(0,(minsSinceDrink-absTime)/60);
      const elimination=beta*hoursAfterPeak;
      
      const drinkBAC=Math.max(0,(peakBAC*absorption)-elimination);
      bac+=drinkBAC;
    }
    
    pts.push({t,bac:Math.round(bac*100)/100});
  }
  
  const nowPt=pts.find(p=>p.t>=now)||pts[pts.length-1];
  return{now:nowPt?.bac||0,pts};
}

function update(data){
  const{now,pts}=calcBAC(data);
  
  // BAC display
  const bacEl=document.getElementById('bac');
  bacEl.textContent=now.toFixed(2);
  bacEl.className='bac-num '+(now<0.3?'bac-ok':now<0.5?'bac-warn':now<0.8?'bac-danger':'bac-extreme');
  
  // Drive
  const driveEl=document.getElementById('drive');
  if(now<0.5){
    driveEl.className='drive-box drive-ok';
    driveEl.innerHTML='üöó Puoi guidare!';
  }else{
    const safe=pts.find(p=>p.t>Date.now()&&p.bac<0.5);
    if(safe){
      const wait=Math.ceil((safe.t-Date.now())/60000);
      const h=Math.floor(wait/60),m=wait%60;
      const time=new Date(safe.t).toLocaleTimeString('it',{hour:'2-digit',minute:'2-digit'});
      driveEl.className='drive-box drive-wait';
      driveEl.innerHTML=`‚õî Aspetta ${h}h ${m}m (ore ${time})`;
    }else{
      driveEl.className='drive-box drive-wait';
      driveEl.innerHTML='‚õî NON guidare!';
    }
  }
  
  // Chart
  const labels=pts.filter((_,i)=>i%3===0).map(p=>new Date(p.t).toLocaleTimeString('it',{hour:'2-digit',minute:'2-digit'}));
  const values=pts.filter((_,i)=>i%3===0).map(p=>p.bac);
  const nowIdx=pts.findIndex(p=>p.t>=Date.now());
  
  if(chart){
    chart.data.labels=labels;
    chart.data.datasets[0].data=values;
    chart.update();
  }else{
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[
          {label:'BAC',data:values,borderColor:'#e94560',backgroundColor:'#e9456033',fill:true,tension:.4,pointRadius:0},
          {label:'Limite',data:Array(labels.length).fill(0.5),borderColor:'#e74c3c55',borderDash:[5,5],pointRadius:0,fill:false}
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          y:{beginAtZero:true,max:1.2,grid:{color:'#ffffff11'},ticks:{color:'#666'}},
          x:{grid:{display:false},ticks:{color:'#666',maxTicksLimit:6}}
        }
      }
    });
  }
  
  // History
  const drinks=data.drinks?Object.entries(data.drinks).map(([id,d])=>({id,...d})).sort((a,b)=>b.t-a.t):[];
  document.getElementById('hist').innerHTML=drinks.length?drinks.map(d=>`
    <div class="hist-item">
      <div>
        <div class="info">${d.e} ${d.n}</div>
        <div class="time">${new Date(d.t).toLocaleTimeString('it',{hour:'2-digit',minute:'2-digit'})}</div>
      </div>
      <button class="del" onclick="del('${d.id}')">‚úï</button>
    </div>`).join(''):'<div class="empty">Nessuna bevanda</div>';
  
  // Food
  const f=data.food||'medio';
  document.querySelectorAll('.food-btn').forEach(b=>b.classList.toggle('active',b.dataset.f===f));
}

onValue(ref(db,`alco/${uid}`),snap=>{if(snap.exists())update(snap.val());});
</script>
</body>
</html>
